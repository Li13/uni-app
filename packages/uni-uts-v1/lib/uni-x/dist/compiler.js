"use strict";require("fs");var e,t,r=require("debug"),i=require("path"),n=require("fs-extra"),s=require("source-map-js");function o(e){return e.replace(/\\/g,"/")}function a(e,t,r,i,n,s,o){return{code:e,category:t,key:r,message:i,reportsUnnecessary:n,elidedInCompatabilityPyramid:s,reportsDeprecated:o}}function l(e){let t,r=()=>{};return t=e?Promise.race([new Promise((t=>setTimeout(t,e,!0))),new Promise((e=>r=e))]):new Promise((e=>r=e)),{promise:t,resolve:r}}!function(e){e[e.Warning=0]="Warning",e[e.Error=1]="Error",e[e.Suggestion=2]="Suggestion",e[e.Message=3]="Message"}(e||(e={})),a(1e5,e.Error,"Type_literal_property_must_have_a_type_annotation_100000","Type literal property must have a type annotation."),a(100001,e.Error,"Only_one_extends_heritage_clause_is_allowed_for_interface_100001","Only one extends heritage clause is allowed for interface"),a(100002,e.Error,"Variable_declaration_must_have_initializer_100002","Variable declaration must have initializer."),a(100003,e.Error,"Nested_type_literal_is_not_supported_100003","Nested type literal is not supported."),a(100004,e.Error,"Invalid_generic_type_which_can_not_be_constructed_100004","Invalid generic type which can not be constructed."),a(100005,e.Error,"script_setup_cannot_contain_ES_module_exports_100005","`<script setup>` cannot contain ES module exports."),function(e){e[e.STARTING_COMPILATION_IN_WATCH_MODE=6031]="STARTING_COMPILATION_IN_WATCH_MODE",e[e.FILE_CHANGE_DETECTED=6032]="FILE_CHANGE_DETECTED",e[e.FOUND_1_ERROR_WATCHING_FOR_FILE_CHANGES=6193]="FOUND_1_ERROR_WATCHING_FOR_FILE_CHANGES",e[e.FOUND_N_ERRORS_WATCHING_FOR_FILE_CHANGES=6194]="FOUND_N_ERRORS_WATCHING_FOR_FILE_CHANGES"}(t||(t={}));class c{constructor(e){this._startDeferred=null,this._finishDeferred=null,this._ts=e}watch(e=1e3){this._startDeferred=l(e),this._finishDeferred=l()}handleStatus(e){if(e.category===this._ts.DiagnosticCategory.Message)switch(e.code){case t.FILE_CHANGE_DETECTED:this.resolveStart();break;case t.FOUND_1_ERROR_WATCHING_FOR_FILE_CHANGES:case t.FOUND_N_ERRORS_WATCHING_FOR_FILE_CHANGES:this.resolveFinish()}}resolveStart(){this._startDeferred&&(this._startDeferred.resolve(!1),this._startDeferred=null)}resolveFinish(){this._finishDeferred&&(this._finishDeferred.resolve(!1),this._finishDeferred=null)}async wait(){if(this._startDeferred){await this._startDeferred.promise&&(this._startDeferred=null,this._finishDeferred=null),await(this._finishDeferred?.promise)}}}const u=r("uts:tsc:compile"),p={strict:!0,noLib:!0,emitUTS:!0,isolatedModules:!0,target:99,module:99,moduleResolution:100};class f{constructor(e){this._rootFiles=[],this._options=e}debug(e,...t){return u(e,...t)}async addRootFile(e,t=1e3){return this.addRootFiles([e],t)}async addRootFiles(e,t=1e3){const r=e.map(o).filter((e=>!this._rootFiles.includes(e)));if(0===r.length)return void(e.length&&u("addRootFile",e,"already exists"));const i=Date.now();this._rootFiles.push(...r),this._watcher.updateRootFileNames(this._rootFiles.slice()),await this.wait(t),u("addRootFiles",r,Date.now()-i)}getRootFiles(){return this._rootFiles}async wait(e=1e3){const t=Date.now();this._helper.watch(e),await this._helper.wait(),u("wait",Date.now()-t)}async close(){this._watcher&&this._watcher.close()}getDiagnostics(){const e=this._watcher?.getProgram();return e?this._options.typescript.getPreEmitDiagnostics(e.getProgram()):[]}async init(){if(this._watcher)return;const e=Date.now(),{typescript:r,compilerOptions:n,rootFiles:s,incremental:a,createTransformers:l,watchFile:f,reportFileName:g,reportDiagnostic:m,normalizeFileName:h,sourceMapCallback:T}=this._options;u.enabled&&r.performance.enable(r.sys);const x=o(this._options.inputDir);this._rootFiles=s.map(o);const _={...n,...p,incremental:a,tsBuildInfoFile:a&&this._options.cacheDir?i.resolve(this._options.cacheDir,".tsbuildInfo"):""};if(_.paths||(_.paths={}),_.paths["@/*"]=[x+"/*"],u.enabled)if(Object.keys(_.paths).length>200){const{paths:e,...t}=_;u("Compiler options:",t)}else u("Compiler options:",_);let S=!0;const N=new Map,v=r.sys.useCaseSensitiveFileNames?d:y,F={...r.sys,watchFile:(e,t,i,n)=>f?f(e,t,i,n):r.sys.watchFile(e,t,i,n),fileExists:e=>!!w(e,r),readFile:(e,t)=>r.sys.readFile(w(e,r),t)};let b;u.enabled&&u("rootFiles",this._rootFiles);const{parser:E,before:D,after:A,afterDeclarations:C}=l({getProgram:()=>b,shouldTransform:function(e){if(N.has(e))return!0;return e.startsWith(x)},normalizeFileName:h});globalThis.__utsParser__||(globalThis.__utsParser__=E),globalThis.__utsCustomParser__=E;const{watcher:k,helper:L}=function(){let e=0;const i=new c(r),n=r.createWatchCompilerHost(s,_,F,r.createEmitAndSemanticDiagnosticsBuilderProgram,m,(function(n){n.category===r.DiagnosticCategory.Message&&(n.code===t.STARTING_COMPILATION_IN_WATCH_MODE||n.code===t.FILE_CHANGE_DETECTED?e=Date.now():n.code!==t.FOUND_1_ERROR_WATCHING_FOR_FILE_CHANGES&&n.code!==t.FOUND_N_ERRORS_WATCHING_FOR_FILE_CHANGES||(u.enabled&&u("Compilation completed in",Date.now()-e,"ms"),function(e,t){if(u.enabled){const r={Files:t.getSourceFiles().length,Identifiers:t.getIdentifierCount(),Symbols:t.getSymbolCount(),Types:t.getTypeCount(),Instantiations:t.getInstantiationCount(),"Memory used":Math.round((e.sys.getMemoryUsage?e.sys.getMemoryUsage():-1)/1e3/1e3)+"M",cache:t.getRelationCacheSizes()};e.performance.forEachMeasure(((e,t)=>{r[e]=t})),u("performance:"),u(r),e.performance.disable(),e.performance.enable(e.sys)}}(r,b)));i.handleStatus(n)}));const o=n.createProgram;n.createProgram=(e,t,r,i)=>{!function(e){const t=e.resolveModuleNameLiterals;e.resolveModuleNameLiterals=(e,r,i,n,s,o)=>{const a=t(e,r,i,n,s,o);return a.forEach((({resolvedModule:e})=>{if(e){const t=N.get(v(e.resolvedFileName));t&&(e.resolvedFileName=t)}})),a}}(r);const n=o(e,t,r,i);return function(e,t){b=t;const r=t.emit.bind(t);t.emit=(i,n,s,o,a)=>{a||(a={}),(a.before||(a.before=[])).push(...D),(a.after||(a.after=[])).push(...A),(a.afterDeclarations||(a.afterDeclarations=[])).push(...C);return r(i,((r,i,s,o,a,l)=>{if(n=n||e?.writeFile||t.writeFile,!(T&&r.endsWith(".map")&&T(r,i,((e,t)=>n(e,t,s,o,a,l)))))return n(r,i,s,o,a,l)}),s,o,a)}}(r,n.getProgram()),function(e){if(u.enabled){const t=e.getSourceFiles(),r=[],i=[],n=[];t.forEach((e=>{const{type:t,fileName:s}=g(e.fileName);"system"===t?r.push(s):"user"===t?i.push(s):n.push(s)})),S&&(S=!1,u("libs:",r.length),r.sort().forEach((e=>u("  ",e))),u("users:",i.length),i.sort().forEach((e=>u("  ",e))),u("others:",n.length),n.sort().forEach((e=>u("  ",e)))),u("sourceFiles",{total:t.length,libs:r.length,users:i.length,others:n.length})}}(n.getProgram()),n};const a=r.createWatchProgram(n);return{watcher:a,helper:i}}();return this._watcher=k,this._helper=L,void u("init",Date.now()-e);function w(e,t){const r=v(e),i=N.get(r);if(i)return i;let n=e.split("?",2)[0];const s=n.endsWith(".ts");if(!s){const e=n+".ts";if(t.sys.fileExists(e))return N.set(r,e),n}if(t.sys.fileExists(n))return N.set(r,n),n;if(s){const e=n.slice(0,-3),i=[".uvue.ts",".uts.ts",".vue.ts"];for(const n of i){const i=e+n;if(t.sys.fileExists(i))return N.set(r,i),i}}}}}function d(e){return e}function g(e){return e.toLowerCase()}const m=/[^\u0130\u0131\u00DFa-z0-9\\/:\-_. ]+/g;function y(e){return m.test(e)?e.replace(m,g):e}function h(e){return e.endsWith(".uts.ts")?e.replace(/\.uts\.ts$/,""):e.replace(/\.\w+$/,"")}function T(e,t,r,i){return n=>{const s=r(n);return r=>{const o=e.isSourceFile(r);return n.fileName||o&&(n.fileName=r.fileName),t.shouldTransform(n.fileName)?(o&&!r.isUTSFile&&(r.isUTSFile=!0,t.isVueFile?.(n.fileName)&&(r.isVueFile=!0)),o&&"parser"===i&&r.statements.length&&(r.statements[0].parent||e.setParentRecursive(r,!0)),s(r)):r}}}function x(e,t){return t&&t!==e&&!Array.isArray(t)&&(t.__parsedByUtsParser=!0,t.parent=e.parent),t}let _;function S(e,t,r){return function(e){if(!e.ObjectFlags.UTSType){const{Class:t,Interface:r,Reference:i,Anonymous:n,ArrayLiteral:s}=e.ObjectFlags;e.ObjectFlags.UTSType=t|r|i|n|s}if(!e.TypeFlags.UTSType){const{Any:t,String:r,Number:i,Boolean:n,Enum:s,StringLiteral:o,NumberLiteral:a,BooleanLiteral:l,EnumLiteral:c,Void:u,Null:p,Object:f,Union:d,TemplateLiteral:g}=e.TypeFlags;e.TypeFlags.UTSType=t|r|i|n|s|o|a|l|c|u|p|f|d|g,e.TypeFlags.UTSStringLike=r|o|g,e.TypeFlags.UTSNumberLike=i|a}}(e),i=>{const n={},s=[],o=[],a=[];return t.forEach((t=>{let l=t(e,i,r);if("function"==typeof l)s.push(T(e,i,l,"before"));else{if(l.parser){const s=t(function(e){if(_)return _;_={...e};const{visitNode:t,visitEachChild:r}=e;return _.visitNode=(e,r)=>t(e,(e=>x(e,r(e)))),_.visitEachChild=(e,t,i)=>r(e,(e=>x(e,t(e))),i),_}(e),i,r);s.parser&&function(e,t,r,i){i.TypeAliasDeclaration&&(r.TypeAliasDeclaration||(r.TypeAliasDeclaration=[])).push(T(e,t,(e=>{const t=i.TypeAliasDeclaration(e);return e=>x(e,t(e))}),"parser")),i.SourceFile&&(r.SourceFile||(r.SourceFile=[])).push(T(e,t,i.SourceFile,"parser"))}(e,i,n,s.parser)}l.before&&s.push(T(e,i,l.before,"before")),l.after&&o.push(T(e,i,l.after,"after")),l.afterDeclarations&&a.push(T(e,i,l.afterDeclarations,"afterDeclarations"))}})),{parser:n,before:s,after:o,afterDeclarations:a}}}function N(e,t,r){if(r.flags&e.TypeFlags.TypeParameter)return!0;if(r.isUnion()){if(r.types.length>2)return!1;if(r===t.getBooleanType())return!0;const i=t.getNullType(),n=r.types[0],s=r.types[1];return n===i&&N(e,t,s)||s===i&&N(e,t,n)}return r.flags&e.TypeFlags.Object?!!(r.objectFlags&e.ObjectFlags.UTSType):!!(r.flags&e.TypeFlags.UTSType)}function v(e,t,r){const i=e.getOriginalNode(r);return e.isExpression(i)?t.getContextualType(i):void 0}function F(e,t){return e.getContextualType(t)??e.getTypeAtLocation(t)}function b(e,t){return t?e.getNonNullableType(t):t}function E(e,t){return t.flags&e.TypeFlags.Object&&t.objectFlags&e.ObjectFlags.Anonymous&&!t.aliasSymbol&&0===t.getCallSignatures().length}function D(e,t,r){const i=e.getOriginalNode(r).parent;if(i&&e.isObjectLiteralExpression(i)&&e.isIdentifier(r.name)){const e=t.getContextualType(i);if(e){const i=e.getProperty(r.name.text);if(i)return t.getTypeOfSymbol(i)}}}function A(e,t,r){return e.flags&t.TypeFlags.UTSNumberLike||e===(r.getUTSNumberType||r.getNumberType)?.()}function C(e,t,r){return r.flags&e.TypeFlags.StringLiteral?t.getStringType():r.flags&e.TypeFlags.NumberLiteral?t.getNumberType():r.flags&e.TypeFlags.BigIntLiteral?t.getBigIntType():r.flags&e.TypeFlags.BooleanLiteral?t.getBooleanType():r.flags&e.TypeFlags.Union?k(e,t,r,C):r}function k(e,t,r,i,n){if(r.flags&e.TypeFlags.Never)return r;if(!(r.flags&e.TypeFlags.Union))return i(e,t,r);const s=r.origin,o=s&&s.flags&e.TypeFlags.Union?s.types:r.types;let a,l=!1;for(const r of o){const s=r.flags&e.TypeFlags.Union?k(e,t,r,i,n):i(e,t,r);l||(l=r!==s),s&&(a?a.push(s):a=[s])}return l?a&&t.getUnionType(a,n?e.UnionReduction.None:e.UnionReduction.Literal):r}function L(e,t){return t.map((t=>e.isIdentifier(t.name)?t.name.text:t.name)).join(", ")}r("uts:transformer:importAndExportDeclaration");const w=r("uts:transformer:autoImport");function P(e,t,r){const i=new Map;r.statements.forEach((r=>{if(!e.isImportDeclaration(r))return;const n=r.importClause;if(!n)return;const{name:s,namedBindings:a}=n;a&&e.isNamedImports(a)&&a.elements.forEach((e=>{const r=t.getSymbolAtLocation(e.name);if(r){const n=function(e){const{declarations:t}=e;if(!t||1!==t.length)return;return h(o(t[0].getSourceFile().fileName))}(t.getAliasedSymbol(r));if(!n)return;i.has(n)||i.set(n,{}),i.get(n)[e.name.text]=e.propertyName?.text??e.name.text}}))})),r.__imports=i}function O(e,t,r,n,s,a){let{aliasSymbol:l}=b(r,n);if(!l)return;const c=function(e,t,r){if(t.declarations)for(const i of t.declarations){const t=i.getSourceFile();if(t.isDeclarationFile)return;if(t===r||t.fileName===r.fileName)return;if(e.isModuleDeclaration(i))return;return h(o(t.fileName))}}(e,l,s);if(c){const{factory:n}=e,u=l.getName();s.__imports||P(e,r,s);const p=s.__imports;if(p.has(c)){const e=p.get(c);if(e[u])return e[u]}const f=function(e,t,r){let i=e.getUniqueName(t,r);r.__uniqueNames||(r.__uniqueNames=[]);let n=1;for(;r.__uniqueNames.includes(i);)i=`${t}_${n}`,n++;return r.__uniqueNames.push(i),i}(e,u,s);let d=c;const g=s.__rootDir;if(g&&c.startsWith(g)){const e=h(o(s.fileName));e.startsWith(g)&&(d=t.normalizeFileName(i.relative(i.dirname(e),c)),d=d.startsWith(".")?d:"./"+d)}const m=n.createImportDeclaration(void 0,n.createImportClause(!1,void 0,n.createNamedImports([n.createImportSpecifier(!1,f!==u?n.createIdentifier(u):void 0,n.createIdentifier(f))])),n.createStringLiteral(d),void 0);return w.enabled&&w(`import { ${u} as ${f} } from '${d}'`,"at",s.__relativeFileName),a.set(l,m),p.has(c)||p.set(c,{}),p.get(c)[u]=f,f}}const I=32768;function R(e,t){return!!(t.isUnion()&&t.objectFlags&I)}function U(e,t){return t.flags===e.TypeFlags.Null||t.flags===e.TypeFlags.Undefined}function K(e,t,r){if(r.isStringLiteral())return function(e){M||(M=e.factory.createKeywordTypeNode(e.SyntaxKind.StringKeyword));return M}(e);if(r.isNumberLiteral())return function(e){G||(G=e.factory.createKeywordTypeNode(e.SyntaxKind.NumberKeyword));return G}(e);if(r.flags&e.TypeFlags.BooleanLiteral)return function(e){j||(j=e.factory.createKeywordTypeNode(e.SyntaxKind.BooleanKeyword));return j}(e);if(r.isUnion()){const i=r.types.filter((t=>!U(e,t)));if(i.length){let n=i[0];for(let e=1;e<i.length;e++)if(i[e].flags!==n.flags)return;if(i.length===r.types.length)return K(e,t,n);{const r=K(e,t,n);if(r)return e.factory.createUnionTypeNode([r,W(e)])}}}}let $,M,G,j;function W(e){return $||($=e.factory.createLiteralTypeNode(e.factory.createNull())),$}function q(e,t,r,i){return i===t.getUTSStringType?.()||i.flags&e.TypeFlags.UTSStringLike?!!(r.flags&e.TypeFlags.UTSStringLike)||R(0,r)&&r.types.every((e=>e.isStringLiteral())):!!A(i,e,t)&&(!!(r.flags&e.TypeFlags.UTSNumberLike)||R(0,r)&&function(e){return e.types.every((e=>e.isNumberLiteral()))}(r))}function B(e,t,r,i){if(U(e,r)&&function(e,t){return t.flags&(e.TypeFlags.Null|e.TypeFlags.Undefined)}(e,i))return!0;if(q(e,t,r,i)||q(e,t,i,r))return!0;if(t&&t.getGlobalType&&!t.getUTSJSONObjectType){const e=t.getGlobalType("UTSJSONObject",0,!0);t.getUTSJSONObjectType=()=>e;const r=t.getGlobalType("String",0,!0);t.getUTSStringType=()=>r;const i=t.getGlobalType("Number",0,!0);t.getUTSNumberType=()=>i}const n=t.getUTSJSONObjectType?.();if(n){const s=t.getNonNullableType(i);if(E(e,r)&&s===n||E(e,i)&&r===n)return!0}}const z={isRelatedTo:B,isTypeRelatedTo:function(e,t,r,i){return B(e,t,r,i)},useTypeAndInterfaceAsValue:!0},H=r("uts:transformer:arguments"),V=(e,t,r)=>{const i=r.transformArguments?.shouldTransform??(()=>!0);return{before(n){const s=t.getProgram().getTypeChecker(),{factory:o}=n,a=new Map;let l;const c=t=>{const a=e.visitEachChild(t,c,n);if(e.isMethodDeclaration(a)){const t=b(s,D(e,s,a));if(t){if(!i(a,t,s))return a;const r=t.getCallSignatures();if(r&&r.length){const t=X(e,o,r,a.parameters);if(t)return H.enabled&&H("method:",`${a.name?.getText()}(${L(e,t)}) at ${l.__relativeFileName}`),o.updateMethodDeclaration(a,a.modifiers,a.asteriskToken,a.name,a.questionToken,a.typeParameters,t,a.type,a.body)}}}else if(e.isArrowFunction(a)){const t=b(s,F(s,a));if(!i(a,t,s))return a;const r=t.getCallSignatures();if(r&&r.length){const t=X(e,o,r,a.parameters);if(t)return H.enabled&&H("arrow function:",`(${L(e,t)}) at ${l.__relativeFileName}`),o.updateArrowFunction(a,a.modifiers,a.typeParameters,t,a.type,a.equalsGreaterThanToken,a.body)}}else if(e.isFunctionExpression(a)){const t=b(s,F(s,a));if(!i(a,t,s))return a;const r=t.getCallSignatures();if(r&&r.length){const t=X(e,o,r,a.parameters);if(t)return H.enabled&&H("function expression:",`(${L(e,t)}) at ${l.__relativeFileName}`),o.updateFunctionExpression(a,a.modifiers,a.asteriskToken,a.name,a.typeParameters,t,a.type,a.body)}}else if(("Kotlin"===r.targetLanguage||"Swift"===r.targetLanguage)&&e.isCallExpression(a)&&0===a.arguments.length){const t=b(s,F(s,a.expression)).getCallSignatures();if(t&&1===t.length){const r=t[0].parameters;if(1===r.length){if(J(s.getTypeOfSymbol(r[0]),e))return o.updateCallExpression(a,a.expression,a.typeArguments,o.createNodeArray([o.createVoidExpression(o.createNumericLiteral(0))]))}}}return a};return t=>{l=t;const r=e.visitNode(t,c);return 0===a.size?r:o.updateSourceFile(r,[...a.values(),...r.statements],r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}};function J(e,t){return!!(e.flags&t.TypeFlags.Void)||e.isUnion()&&e.types.some((e=>J(e,t)))}function X(e,t,r,i){let n;const s=i.length;for(const e of r){if(e.parameters.length===s)return;e.parameters.length>s&&(!n||e.parameters.length<n.parameters.length)&&(n=e)}if(!n)return;const o=[];for(const t of n.parameters){if(!t.valueDeclaration)return;if(!e.isParameter(t.valueDeclaration))return;if(t.valueDeclaration.questionToken||t.valueDeclaration.dotDotDotToken)break;o.push(t)}const a=o.length-s;if(a<=0)return;const l=[];for(let e=0;e<a;e++)l.push(t.createParameterDeclaration(void 0,void 0,t.createIdentifier(`_${n.parameters[e+s].name}`),void 0,void 0,void 0));return t.createNodeArray([...i,...l])}const Q=(e,t)=>{function r(t,r){if(e.isSourceFile(r)){if(!r.__relativeFileName){const e=t.getCompilerOptions();if(e.rootDir&&i.isAbsolute(e.rootDir)){const t=o(e.rootDir),n=o(r.fileName);r.__rootDir=t,n.startsWith(t)?r.__relativeFileName=o(i.relative(t,n)):n.includes("/@dcloudio/")&&(r.__relativeFileName="@dcloudio/"+n.split("/@dcloudio/")[1])}r.__relativeFileName||(r.__relativeFileName=i.basename(r.fileName))}if(!t.printNode){const r=e.createPrinter();t.printNode=(t,i)=>r.printNode(e.EmitHint.Unspecified,t,i)}t.addBindDiagnostic||(t.addBindDiagnostic=e=>{r.bindDiagnostics.push(e)},t.addBindSuggestionDiagnostic=e=>{r.bindSuggestionDiagnostics||(r.bindSuggestionDiagnostics=[]),r.bindSuggestionDiagnostics.push(e)})}return r}return{before:e=>t=>r(e,t),after:e=>t=>r(e,t),afterDeclarations:e=>t=>r(e,t)}},Y=r("uts:transformer:generics"),Z=(e,t,r)=>{const i=r.transformGenericsParameterDefaults?.shouldTransform??(()=>!0);return{before(r){const n=t.getProgram().getTypeChecker(),{factory:s}=r,o=new Map;let a;const l=c=>{const u=e.visitEachChild(c,l,r);if(e.isTypeReferenceNode(u)){const l=n.getTypeAtLocation(u),c=l.aliasSymbol;if(c&&c.flags&e.SymbolFlags.TypeAlias&&!l.aliasTypeArguments)return u;if(l.resolvedTypeArguments||l.mapper||l.aliasTypeArguments){if(!i(u,l,n,r))return u;const c=ee(u,l.resolvedTypeArguments||function(e){if(!e)return;if(0===e.kind)return[e.target];if(1===e.kind)return e.targets;if(2===e.kind)return e.targets.map((e=>e()))}(l.mapper)||l.aliasTypeArguments,e,n);if(c)return c.newTypes.forEach((r=>O(e,t,n,r,a,o))),Y.enabled&&Y(u.getText(),`${n.typeToString(l)} at ${u.getSourceFile().__relativeFileName}`),s.updateTypeReferenceNode(u,u.typeName,c.newTypeArguments)}}else if(e.isExpressionWithTypeArguments(u)){const l=n.getTypeFromTypeNode(u);if(function(e,t){return!!(function(e,t){return e.flags&t.TypeFlags.Object?e.objectFlags:0}(e,t)&t.ObjectFlags.Reference)}(l,e)&&l.resolvedTypeArguments?.length){if(!i(u,l,n,r))return u;const c=ee(u,l.resolvedTypeArguments,e,n);if(c)return c.newTypes.forEach((r=>O(e,t,n,r,a,o))),Y.enabled&&Y(u.getText(),`${n.typeToString(l)} at ${u.getSourceFile().__relativeFileName}`),s.updateExpressionWithTypeArguments(u,u.expression,c.newTypeArguments)}}else if(e.isNewExpression(u)){const l=n.getTypeAtLocation(u),c=l.resolvedTypeArguments;if(Array.isArray(c)&&c.length){if(!i(u,l,n,r))return u;const p=ee(u,c,e,n);if(p)return p.newTypes.forEach((r=>O(e,t,n,r,a,o))),Y.enabled&&Y(u.getText(),`${n.typeToString(l)} at ${u.getSourceFile().__relativeFileName}`),s.updateNewExpression(u,u.expression,p.newTypeArguments,u.arguments)}}else e.isCallExpression(u);return u};return t=>{a=t;const r=e.visitNode(t,l);return 0===o.size?r:s.updateSourceFile(r,[...o.values(),...r.statements],r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}};function ee(e,t,r,i){const n=e.typeArguments?.length??0;if(t.length===n)return;const s=e.typeArguments??[],o=t.slice(s.length);return{newTypeArguments:r.factory.createNodeArray([...s,...o.map((e=>i.typeToTypeNode(e,void 0,void 0)))]),newTypes:o}}const te=r("uts:transformer:keyof"),re=(e,t,r)=>{const i=r.transformKeyof?.shouldTransform??(()=>!0);return{before(r){const n=t.getProgram().getTypeChecker(),{factory:s}=r,o=t=>{const a=e.visitEachChild(t,o,r);if(e.isTypeOperatorNode(a)&&a.operator===e.SyntaxKind.KeyOfKeyword){const e=n.getTypeAtLocation(a);if(!i(a,e,n,r))return a;if(e.isUnion()){const t=e.types.map((e=>e.isStringLiteral()||e.isNumberLiteral()?e.value:void 0)).filter((e=>void 0!==e));return te.enabled&&te(a.getText(),`${n.typeToString(e)} at ${a.getSourceFile().__relativeFileName}`),s.createUnionTypeNode(t.map((e=>s.createLiteralTypeNode("string"==typeof e?s.createStringLiteral(e):s.createNumericLiteral(e)))))}if(e.isStringLiteral())return te.enabled&&te(a.getText(),`${n.typeToString(e)} at ${a.getSourceFile().__relativeFileName}`),s.createLiteralTypeNode(s.createStringLiteral(e.value));if(e.isNumberLiteral())return te.enabled&&te(a.getText(),`${n.typeToString(e)} at ${a.getSourceFile().__relativeFileName}`),s.createLiteralTypeNode(s.createNumericLiteral(e.value))}return a};return t=>e.visitNode(t,o)}}},ie=e=>({parser:{SourceFile(t){const r=t=>{t.forEachChild(r);t.parent&&e.isBinaryExpression(t)&&(t.left.kind!==e.SyntaxKind.NullKeyword&&t.right.kind!==e.SyntaxKind.NullKeyword||(t.operatorToken.kind===e.SyntaxKind.EqualsEqualsEqualsToken?t.operatorToken.kind=e.SyntaxKind.EqualsEqualsToken:t.operatorToken.kind===e.SyntaxKind.ExclamationEqualsEqualsToken&&(t.operatorToken.kind=e.SyntaxKind.ExclamationEqualsToken)))};return e=>(e.forEachChild(r),e)}}}),ne=r("uts:transformer:objectLiteral"),se=(e,t,r)=>{const i=r?.transformObjectLiteral?.shouldTransformAsExpression??(()=>!0);return{parser:{SourceFile(t){const{factory:r}=t;let i;function n(t){if(ne.enabled){const{line:r,character:n}=e.getLineAndCharacterOfPosition(i,t.getEnd());ne("createAs:",`at ${i.fileName}:${r+1}:${n}`)}return r.createAsExpression(t,r.createTypeReferenceNode(r.createIdentifier("UTSJSONObject"),void 0))}function s(t){if(ne.enabled){const{line:r,character:n}=e.getLineAndCharacterOfPosition(i,t.getEnd());ne("createAsArray:",`at ${i.fileName}:${r+1}:${n}`)}return r.createAsExpression(t,r.createArrayTypeNode(r.createTypeReferenceNode(r.createIdentifier("UTSJSONObject"),void 0)))}const o=t=>{t.forEachChild(o);const i=t.parent;if(i)if(e.isObjectLiteralExpression(t))e.isExportAssignment(i)?i.expression=n(t):e.isVariableDeclaration(i)&&!i.type||e.isPropertyDeclaration(i)&&!i.type?i.initializer=n(t):oe(e,i)&&(i.expression=e.isParenthesizedExpression(i)?n(t):r.createParenthesizedExpression(n(t)));else if(e.isArrayLiteralExpression(t)){t.elements.length&&t.elements.every((t=>e.isObjectLiteralExpression(t)))&&(e.isExportAssignment(i)?i.expression=s(t):e.isVariableDeclaration(i)&&!i.type||e.isPropertyDeclaration(i)&&!i.type?i.initializer=s(t):oe(e,i)&&(i.expression=e.isParenthesizedExpression(i)?s(t):r.createParenthesizedExpression(s(t))))}};return e=>(i=e,e.forEachChild(o),e)}},before(r){const n=t.getProgram().getTypeChecker(),{factory:s}=r,o=new Map;let a;const l=c=>{const u=e.visitEachChild(c,l,r);if(e.isObjectLiteralExpression(u)){const r=e.getOriginalNode(u).parent;if(r){if(e.isAsExpression(r))return u;if(e.isVariableDeclaration(r)&&r.type)return u}if(!i(u))return u;const l=function(e,t,r){if(r&&(r=b(t,r)).symbol&&r.aliasSymbol&&r.aliasSymbol.flags&e.SymbolFlags.TypeAlias&&1===r.aliasSymbol.declarations?.length){const t=r.aliasSymbol.declarations[0];if(e.isTypeAliasDeclaration(t)&&e.isTypeLiteralNode(t.type)&&t.type.members.every((t=>e.isPropertySignature(t)||e.isCallSignatureDeclaration(t))))return r}}(e,n,F(n,u));if(l){const r=O(e,t,n,l,a,o)||l.aliasSymbol.name;return s.createAsExpression(u,s.createTypeReferenceNode(r))}}return u};return t=>{a=t;const r=e.visitNode(t,l);return 0===o.size?r:s.updateSourceFile(r,[...o.values(),...r.statements],r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}};function oe(e,t){return e.isParenthesizedExpression(t)&&t.parent?oe(e,t.parent):e.isPropertyAccessExpression(t)}const ae=r("uts:transformer:returnType"),le=(e,t,r)=>{const i=r?.transformReturnType?.shouldTransform??(()=>!0);return{before(r){const n=t.getProgram().getTypeChecker(),{factory:s}=r,o=new Map;let a;const l=c=>{const u=e.visitEachChild(c,l,r);if(e.isFunctionDeclaration(u)){if(!u.type){const r=n.getSignatureFromDeclaration(u);if(r){const i=n.getReturnTypeOfSignature(r),l=ue(e,n,i,!1);if(l)return ae.enabled&&ae("function:",`${u.name?.getText()}():${ce(e,n,l,i)} at ${a.__relativeFileName}`),O(e,t,n,i,a,o),s.updateFunctionDeclaration(u,u.modifiers,u.asteriskToken,u.name,u.typeParameters,u.parameters,l,u.body)}}}else if(e.isMethodDeclaration(u)){if(!u.type){const r=n.getTypeAtLocation(u).getCallSignatures()[0];if(r&&r.getReturnType().flags&e.TypeFlags.Void)return u;const l=D(e,n,u);if(l&&!i(e.getOriginalNode(u),l,n))return u;const c=b(n,l)?.getCallSignatures(),p=c&&c.length?c[0]:n.getSignatureFromDeclaration(u);if(p){const r=n.getReturnTypeOfSignature(p),i=ue(e,n,r,!(!c||!c.length));if(i)return ae.enabled&&ae("method:",`${u.name?.getText()}():${ce(e,n,i,r)} at ${a.__relativeFileName}`),O(e,t,n,r,a,o),s.updateMethodDeclaration(u,u.modifiers,u.asteriskToken,u.name,u.questionToken,u.typeParameters,u.parameters,i,u.body)}}}else if(e.isArrowFunction(u)){if(!u.type){const r=n.getTypeAtLocation(u).getCallSignatures()[0];if(r&&r.getReturnType().flags&e.TypeFlags.Void)return u;const l=v(e,n,u);if(l&&!i(e.getOriginalNode(u),l,n))return u;const c=(l??n.getTypeAtLocation(u))?.getCallSignatures();if(c&&c.length){const r=c[0].getReturnType(),i=ue(e,n,r,!!l);if(i)return ae.enabled&&ae("arrow function:",`():${ce(e,n,i,r)} at ${a.__relativeFileName}`),O(e,t,n,r,a,o),s.updateArrowFunction(u,u.modifiers,u.typeParameters,u.parameters,i,u.equalsGreaterThanToken,u.body)}}}else if(e.isFunctionExpression(u)&&!u.type){const r=n.getTypeAtLocation(u).getCallSignatures()[0];if(r&&r.getReturnType().flags&e.TypeFlags.Void)return u;const l=v(e,n,u);if(l&&!i(e.getOriginalNode(u),l,n))return u;const c=(l??n.getTypeAtLocation(u))?.getCallSignatures();if(c&&c.length){const r=c[0].getReturnType(),i=ue(e,n,r,!!l);if(i)return ae.enabled&&ae("function expression:",`():${ce(e,n,i,r)} at ${a.__relativeFileName}`),O(e,t,n,r,a,o),s.updateFunctionExpression(u,u.modifiers,u.asteriskToken,u.name,u.typeParameters,u.parameters,i,u.body)}}return u};return t=>{a=t;const r=e.visitNode(t,l);return 0===o.size?r:s.updateSourceFile(r,[...o.values(),...r.statements],r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}};function ce(e,t,r,i){return e.isTypeReferenceNode(r)&&e.isIdentifier(r.typeName)?r.typeName.text:t.typeToString(i)}function ue(e,t,r,i){if(function(e,t){return!!(t.flags&e.TypeFlags.Any&&t.aliasSymbol)}(e,r))return;const n=K(e,t,r);if(n)return n;const s=!i;if(r.isUnion()&&E(e,b(t,r))){if(!s)return;return e.factory.createUnionTypeNode([e.factory.createTypeReferenceNode(e.factory.createIdentifier("UTSJSONObject")),e.factory.createLiteralTypeNode(e.factory.createNull())])}return r.flags&e.TypeFlags.Void?void 0:E(e,r)?s?e.factory.createTypeReferenceNode(e.factory.createIdentifier("UTSJSONObject")):void 0:N(e,t,r)?t.typeToTypeNode(r,void 0,void 0):void 0}const pe=r("uts:transformer:UTSJSONObject"),fe=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),{factory:n}=r,s=t=>{const o=e.visitEachChild(t,s,r);if(e.isPropertyAccessExpression(o)&&!function(e,t){return e.parent&&t.isCallExpression(e.parent)&&e.parent.expression===e}(o,e)){if(function(e,t){const r=t.getUTSJSONObjectType?.();if(r)return e===r||t.getNonNullableType(e)===r;return!1}(i.getTypeAtLocation(o.expression),i)){const e=o.name.text;return o.questionDotToken?(pe.enabled&&pe(o.getText(),`at ${o.getSourceFile().__relativeFileName}`),n.createElementAccessChain(o.expression,o.questionDotToken,n.createStringLiteral(e))):(pe.enabled&&pe(o.getText(),`at ${o.getSourceFile().__relativeFileName}`),n.createElementAccessExpression(o.expression,n.createStringLiteral(e)))}}return o};return t=>e.visitNode(t,s)}});const de=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),{factory:n}=r,s=t=>{const o=e.visitEachChild(t,s,r);if(e.isBinaryExpression(o)&&o.operatorToken.kind===e.SyntaxKind.EqualsToken){if(A(F(i,o.left),e,i)&&me(o.right,e))return n.createBinaryExpression(o.left,o.operatorToken,n.createCallExpression(n.createIdentifier("Number"),[],[o.right]))}else if(e.isCallExpression(o)&&o.arguments.length){const t=ge(o.arguments,e,i);if(t)return n.updateCallExpression(o,o.expression,o.typeArguments,t)}else if(e.isNewExpression(o)&&o.arguments?.length){const t=ge(o.arguments,e,i);if(t)return n.updateNewExpression(o,o.expression,o.typeArguments,t)}else if(e.isObjectLiteralExpression(o)){let t=!1;const r=o.properties.map((r=>{if(e.isPropertyAssignment(r)&&r.initializer){const s=ge([r.initializer],e,i);if(s)return t=!0,n.updatePropertyAssignment(r,r.name,s[0])}return r}));if(t)return n.updateObjectLiteralExpression(o,r)}return o};return t=>e.visitNode(t,s)}});function ge(e,t,r){const i=[];let n=!1;if(e.forEach((e=>{A(F(r,e),t,r)&&me(e,t)?(n=!0,i.push(t.factory.createCallExpression(t.factory.createIdentifier("Number"),[],[e]))):i.push(e)})),n)return i}function me(e,t){if(t.isNumericLiteral(e))return!0;if(t.isParenthesizedExpression(e))return me(e.expression,t);if(t.isPrefixUnaryExpression(e))switch(e.operator){case t.SyntaxKind.MinusToken:case t.SyntaxKind.PlusToken:case t.SyntaxKind.TildeToken:return me(e.operand,t);default:return!1}if(t.isBinaryExpression(e))switch(e.operatorToken.kind){case t.SyntaxKind.PlusToken:case t.SyntaxKind.MinusToken:case t.SyntaxKind.AsteriskToken:case t.SyntaxKind.SlashToken:case t.SyntaxKind.PercentToken:case t.SyntaxKind.LessThanLessThanToken:case t.SyntaxKind.GreaterThanGreaterThanToken:case t.SyntaxKind.GreaterThanGreaterThanGreaterThanToken:case t.SyntaxKind.CaretToken:case t.SyntaxKind.AmpersandToken:case t.SyntaxKind.BarToken:case t.SyntaxKind.AsteriskAsteriskToken:return me(e.left,t)&&me(e.right,t);default:return!1}return!1}const ye=(e,t)=>({parser:{SourceFile(t){const{factory:r}=t,i=n=>{const s=e.visitEachChild(n,i,t);return e.isTypeAliasDeclaration(s)&&e.isTypeLiteralNode(s.type)&&s.type.members.push(r.createPropertySignature(void 0,r.createComputedPropertyName(r.createIdentifier("UTSObjectMarker")),r.createToken(e.SyntaxKind.QuestionToken),r.createLiteralTypeNode(r.createTrue()))),s};return e=>(e.forEachChild(i),e)}},before(t){const r=i=>{const n=e.visitEachChild(i,r,t);if(!(e.isPropertySignature(n)&&e.isComputedPropertyName(n.name)&&e.isIdentifier(n.name.expression)&&"UTSObjectMarker"===n.name.expression.text))return n};return t=>e.visitNode(t,r)}}),he=(e,t)=>({parser:{SourceFile(t){const{factory:r}=t,i=t=>{t.forEachChild(i),e.isCatchClause(t)&&(t.variableDeclaration?t.variableDeclaration.type||(t.variableDeclaration.type=r.createKeywordTypeNode(e.SyntaxKind.AnyKeyword)):t.variableDeclaration=r.createVariableDeclaration(r.createIdentifier("e"),void 0,r.createKeywordTypeNode(e.SyntaxKind.AnyKeyword)))};return e=>(e.forEachChild(i),e)}}}),Te=r("uts:transformer:decorators:inlineAndReified"),xe=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),{factory:n}=r;function s(t){const s=t.typeParameters.map((e=>e.name.text));const o=function(e,t){const r=[];return t?.forEach((t=>{const i=_e(e,t);i&&r.push(i)})),r}(e,t.modifiers);if(o.includes("reified"))return[];const a={found:!1,keywords:new Map([["reified",!1]]),typeParameterNames:s},l=(t=>{const n=t.keywords,s=o=>{if(e.isCallExpression(o)&&o.typeArguments){const r=o.typeArguments,s=t.typeParameterNames;if(r.some((t=>{if(e.isTypeReferenceNode(t)&&e.isIdentifier(t.typeName)){const e=t.typeName.text;return s.includes(e)}}))){const r=i.getResolvedSignature(o);if(r){const i=r.declaration;i&&(e.getJSDocTags(i).forEach((e=>{const r=e.tagName.text;n.has(r)&&(t.found=!0,n.set(r,!0))})),(e.isFunctionDeclaration(i)||e.isMethodDeclaration(i))&&i.modifiers?.forEach((r=>{const i=_e(e,r);i&&n.has(i)&&(t.found=!0,n.set(i,!0))})))}}}return e.visitEachChild(o,s,r)};return s})(a);if(e.visitEachChild(t,l,r),a.found){const e=[];for(const[t,r]of a.keywords.entries())r&&("reified"!==t||o.includes("inline")||e.push(n.createDecorator(n.createCallExpression(n.createPropertyAccessExpression(n.createIdentifier("UTSAndroid"),n.createIdentifier("keyword")),void 0,[n.createStringLiteral("inline")]))),e.push(n.createDecorator(n.createCallExpression(n.createPropertyAccessExpression(n.createIdentifier("UTSAndroid"),n.createIdentifier("keyword")),void 0,[n.createStringLiteral(t)]))));return e}}const o=t=>{const i=e.visitEachChild(t,o,r);if(e.isFunctionDeclaration(i)&&i.typeParameters){const e=s(i);if(e)return Te.enabled&&Te(i.name?.getText()||i.getText(),`at ${i.getSourceFile().__relativeFileName}`),n.updateFunctionDeclaration(i,n.createNodeArray([...e,...i.modifiers||[]]),i.asteriskToken,i.name,i.typeParameters,i.parameters,i.type,i.body)}else if(e.isMethodDeclaration(i)&&i.typeParameters){const e=s(i);if(e)return Te.enabled&&Te(i.name.getText(),`at ${i.getSourceFile().__relativeFileName}`),n.updateMethodDeclaration(i,n.createNodeArray([...e,...i.modifiers||[]]),i.asteriskToken,i.name,i.questionToken,i.typeParameters,i.parameters,i.type,i.body)}return i};return t=>e.visitNode(t,o)}});function _e(e,t){if(e.isDecorator(t)&&e.isCallExpression(t.expression)&&e.isPropertyAccessExpression(t.expression.expression)&&e.isIdentifier(t.expression.expression.name)&&e.isIdentifier(t.expression.expression.expression)&&"UTSAndroid"===t.expression.expression.expression.text&&"keyword"===t.expression.expression.name.text&&e.isStringLiteral(t.expression.arguments[0]))return t.expression.arguments[0].text}const Se=r("uts:transformer:interface:override"),Ne=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),{factory:n}=r,s=t=>{if(e.isClassDeclaration(t)||e.isClassExpression(t)){const s=t.heritageClauses?.filter((t=>t.token===e.SyntaxKind.ImplementsKeyword)),o=s?.flatMap((e=>e.types.map((e=>i.getTypeAtLocation(e)))));if(o?.length){const s=t=>{if(e.isPropertyDeclaration(t)&&!Fe(t,[e.SyntaxKind.OverrideKeyword,e.SyntaxKind.StaticKeyword])){const r=ve(t,o,e,i);if(r){if(Se.enabled){const r=e.getOriginalNode(t);Se(r.getText(),`at ${r.getSourceFile().__relativeFileName}`)}return n.updatePropertyDeclaration(t,r,t.name,t.questionToken,t.type,t.initializer)}}else if(e.isMethodDeclaration(t)&&!Fe(t,[e.SyntaxKind.OverrideKeyword,e.SyntaxKind.StaticKeyword])){const r=ve(t,o,e,i);if(r){if(Se.enabled){const r=e.getOriginalNode(t);Se(r.getText(),`at ${r.getSourceFile().__relativeFileName}`)}return n.updateMethodDeclaration(t,r,t.asteriskToken,t.name,t.questionToken,t.typeParameters,t.parameters,t.type,t.body)}}return t};return e.visitEachChild(t,s,r)}}return e.visitEachChild(t,s,r)};return t=>e.visitNode(t,s)}});function ve(e,t,r,i){const n=i.getSymbolAtLocation(e.name);if(n){if(t.some((e=>e.getProperties().some((e=>e.name===n.name))))){return e.modifiers?[...e.modifiers.filter((e=>be(e,r))),r.factory.createModifier(r.SyntaxKind.OverrideKeyword),...e.modifiers.filter((e=>!be(e,r)))]:[r.factory.createModifier(r.SyntaxKind.OverrideKeyword)]}}}function Fe(e,t){return e.modifiers?.some((e=>t.includes(e.kind)))}function be(e,t){return e.kind===t.SyntaxKind.Decorator||e.kind===t.SyntaxKind.PublicKeyword||e.kind===t.SyntaxKind.ProtectedKeyword||e.kind===t.SyntaxKind.PrivateKeyword||e.kind===t.SyntaxKind.AbstractKeyword}const Ee=r("uts:transformer:number:toString"),De=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),{factory:n}=r,s=t=>{const o=e.visitEachChild(t,s,r);if(e.isCallExpression(o)&&0===o.arguments.length&&e.isPropertyAccessExpression(o.expression)&&"toString"===o.expression.name.text){const t=i.getTypeAtLocation(o.expression.expression);return t.flags&e.TypeFlags.NumberLiteral||t.flags&e.TypeFlags.Number?n.updateCallExpression(o,o.expression,o.typeArguments,[n.createNumericLiteral("10")]):o}if(e.isBinaryExpression(o)&&o.operatorToken.kind===e.SyntaxKind.PlusToken&&e.isNumericLiteral(o.right)&&o.right.getText().includes(".")){if(i.getTypeAtLocation(o).flags&e.TypeFlags.String)return Ee.enabled&&Ee(o.right.getText(),`at ${o.getSourceFile().__relativeFileName}`),n.updateBinaryExpression(o,o.left,o.operatorToken,n.createCallExpression(n.createPropertyAccessExpression(o.right,"toString"),void 0,[n.createNumericLiteral("10")]))}else if(e.isTemplateSpan(o)&&e.isNumericLiteral(o.expression)&&o.expression.getText().includes("."))return Ee.enabled&&Ee(o.expression.getText(),`at ${o.getSourceFile().__relativeFileName}`),n.updateTemplateSpan(o,n.createCallExpression(n.createPropertyAccessExpression(o.expression,"toString"),void 0,[n.createNumericLiteral("10")]),o.literal);return o};return t=>e.visitNode(t,s)}}),Ae=r("uts:transforms:rest_parameters"),Ce="do_not_transform_spread",ke=(e,t,r)=>{const i=r.transformRestParameters?.shouldTransform??(()=>!0);return{before(r){const n=t.getProgram().getTypeChecker(),{factory:s}=r,o=t=>{const a=e.visitEachChild(t,o,r);if(e.isMethodDeclaration(a)&&a.parameters.length&&a.body){const o=b(n,D(e,n,a));if(o){const l=o.getCallSignatures();if(l&&1===l.length){if(!i(a,l[0],n,r))return a;const o=Le(l[0],a,e);if(o)return Ae.enabled&&Ae("method:",`${a.name?.getText()}(${L(e,o.parameters)}) at ${t.getSourceFile().__relativeFileName}`),s.updateMethodDeclaration(a,a.modifiers,a.asteriskToken,a.name,a.questionToken,a.typeParameters,o.parameters,a.type,s.createBlock([...o.statements,...a.body.statements]))}}}else if(e.isArrowFunction(a)&&a.parameters.length){const o=b(n,n.getContextualType(a));if(o){if(o!==n.getTypeAtLocation(a)){const l=o.getCallSignatures();if(l&&l.length){if(!i(a,l[0],n,r))return a;const o=Le(l[0],a,e);if(o){Ae.enabled&&Ae("arrow function:",`(${L(e,o.parameters)}) at ${t.getSourceFile().__relativeFileName}`);const r=e.isExpression(a.body)?s.createBlock([...o.statements,s.createReturnStatement(a.body)]):s.createBlock([...o.statements,...a.body.statements]);return Oe(l[0],a,s.updateArrowFunction(a,a.modifiers,a.typeParameters,o.parameters,a.type,a.equalsGreaterThanToken,r),e)}}}}}else if(e.isFunctionExpression(a)&&a.parameters.length){const o=b(n,n.getContextualType(a));if(o){if(o!==n.getTypeAtLocation(a)){const l=o.getCallSignatures();if(l&&l.length){if(!i(a,l[0],n,r))return a;const o=Le(l[0],a,e);if(o)return Ae.enabled&&Ae("function expression:",`(${L(e,o.parameters)}) at ${t.getSourceFile().__relativeFileName}`),Oe(l[0],a,s.updateFunctionExpression(a,a.modifiers,a.asteriskToken,a.name,a.typeParameters,o.parameters,a.type,s.createBlock([...o.statements,...a.body.statements])),e)}}}}return a};return t=>e.visitNode(t,o)}}};function Le(e,t,r){const i=function(e,t){if(e.parameters.length){const r=e.parameters[e.parameters.length-1];if(r.valueDeclaration&&t.isParameter(r.valueDeclaration)&&r.valueDeclaration.dotDotDotToken)return e.parameters.length-1}return-1}(e,r);if(-1!==i&&i<t.parameters.length){const e=function(e,t){if(e.find((e=>!t.isIdentifier(e.name))))return[];return e.map((e=>({name:e.name.getText(),isRestParameter:!!e.dotDotDotToken})))}(t.parameters.slice(i),r);if(e.length)return{parameters:r.factory.createNodeArray([...t.parameters.slice(0,i),(n=r.factory,n.createParameterDeclaration(void 0,void 0,n.createIdentifier(Ce),void 0,void 0,void 0))]),statements:we(e,r.factory)}}var n}function we(e,t){return t.createNodeArray(e.map((({name:e,isRestParameter:r},i)=>function(e,t,r,i){return i.createVariableStatement(void 0,i.createNodeArray([Pe(e,t,r,i)]))}(e,i,r,t))))}function Pe(e,t,r,i){return i.createVariableDeclaration(i.createIdentifier(e),void 0,void 0,r?i.createNewExpression(i.createIdentifier("Array"),void 0,[i.createSpreadElement(i.createIdentifier(Ce))]):i.createElementAccessExpression(i.createIdentifier(Ce),i.createNumericLiteral(t.toString())))}function Oe(e,t,r,i){const n=i.getOriginalNode(t).parent;if(n&&(i.isVariableDeclaration(n)||i.isBinaryExpression(n)&&n.operatorToken.kind===i.SyntaxKind.EqualsToken)&&e.declaration&&e.declaration.parent){const t=e.declaration.parent;if(i.isTypeAliasDeclaration(t)){const e=t.name.getText(),n=i.factory;return n.createNewExpression(n.createIdentifier(e),void 0,[r])}}return r}const Ie=r("uts:transformer:narrowType"),Re=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),{factory:n}=r,s=t=>{if(e.isExpression(t)&&t.__evolvedType){const r=C(e,i,t.__evolvedType),s=i.typeToTypeNode(r,void 0,void 0);if(s)return Ie.enabled&&Ie(t.getText(),`as ${i.typeToString(r)} at ${t.getSourceFile().__relativeFileName}`),n.createAsExpression(t,s)}return e.visitEachChild(t,s,r)};return t=>e.visitNode(t,s)}});const Ue={componentPublicInstancePropertyAccessFallback:function(e,t,r,i,n,s){if(!e.isPropertyAccessExpression(r)||!e.isExpression(i)||!e.isIdentifier(s))return;const o=n.aliasSymbol?.escapedName.toString();if("ComponentPublicInstance"!==o&&"CreateComponentPublicInstance"!==o)return;const a=s.escapedText.toString(),l=globalThis?.__utsUniXGlobalProperties__;if(l&&l.has(a)){const{initializerNode:r}=l.get(a),i=t.getTypeAtLocation(r);return i.isNumberLiteral()?t.getNumberType():i.isStringLiteral()?t.getStringType():i.flags&e.TypeFlags.BooleanLiteral?t.getBooleanType():i}},filterReferencedByPaths:function(e,t){if(t&&e.endsWith(".uvue.ts"))for(const[e]of t?.entries())if(e.endsWith("main.uts.ts"))return void t.delete(e)}};globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;const Ke=e=>({parser:{SourceFile:t=>r=>{const i=r.fileName,n=globalThis?.__utsUniXGlobalProperties__;if(n)for(const[e,t]of n)t.file===i&&n.delete(e);return function r(s){if(e.isBinaryExpression(s)){const{left:t,operatorToken:r,right:o}=s;if(r.kind===e.SyntaxKind.EqualsToken&&e.isPropertyAccessExpression(t)){const{expression:r,name:s}=t;if(e.isPropertyAccessExpression(r)){const{expression:t,name:a}=r;if("globalProperties"===a.escapedText.toString()&&e.isPropertyAccessExpression(t)){const{name:e}=t;"config"===e.escapedText.toString()&&n.set(s.escapedText.toString(),{file:i,initializerNode:o})}}}}return e.visitEachChild(s,r,t)}(r)}}});let $e=null,Me=[];const Ge=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker();null===$e&&i.getGlobalType&&($e=i.getGlobalType("UniApp",0,!1),$e&&(Me=$e.getProperties().map((e=>e.getName()))));const n=t=>{if($e&&Me.length){if(e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&e.isIdentifier(t.expression.name)){const r=F(i,t.expression.expression);if(r&&r.isIntersection()&&r.types.some((e=>"UniApp"===e.symbol?.name))&&!Me.includes(t.expression.name.text)){console.error(`error: '${t.expression.name.text}' 不是 UniApp 对象的方法，请检查是否拼写错误，如果想调用在 App.uvue 文件中定义的 methods 方法，请使用 .vm?.xxx 的方式调用，详情参考：https://doc.dcloud.net.cn/uni-app-x/api/get-app.html#appmethods`);const r=t.getSourceFile();if(r.__relativeFileName){const i=e.getLineAndCharacterOfPosition(r,t.pos),n=r.__relativeFileName.split("?")[0].replace(/\.(vue|uvue|uts).ts$/g,".$1");console.error("at "+n+":"+i.line)}}}return e.visitEachChild(t,n,r)}return t};return t=>e.visitNode(t,n)}});var je;function We(e){return{...z,...Ue}}function qe(e,t={}){const r=[Q];return e!==exports.TargetLanguage.Kotlin&&e!==exports.TargetLanguage.Swift||(r.push(ye,re,ie),t.enableGenericsParameterDefaults&&r.push(Z),t.enableNarrowType&&r.push(Re)),e!==exports.TargetLanguage.Kotlin&&e!==exports.TargetLanguage.Swift&&e!==exports.TargetLanguage.ArkTS||r.push(fe),e===exports.TargetLanguage.Kotlin&&(r.push(Ge,Ne,he,xe,De,ke),t.enableUTSNumber&&r.push(de)),r.push(Ke,V,se,le),r}exports.TargetLanguage=void 0,(je=exports.TargetLanguage||(exports.TargetLanguage={})).Kotlin="Kotlin",je.Swift="Swift",je.ArkTS="ArkTS",je.JavaScript="JavaScript";const Be=["map","filter","forEach","every","some","find","findIndex","reduce","reduceRight"];function ze(e){return e.symbol&&["Set","Map"].includes(e.symbol.escapedName)}const He=r("uts:tsc:compile");const Ve=["uni","uniCloud"];function Je(e,t){if(e.isPropertyAccessExpression(t.expression)&&e.isIdentifier(t.expression.expression)){const e=t.expression.expression.getText();if(Ve.includes(e))return!0}return!1}const Xe=["defineApp","defineComponent","defineAsyncComponent","defineMixin"];function Qe(e){return e===exports.TargetLanguage.Kotlin?"app-android":e===exports.TargetLanguage.Swift?"app-ios":e===exports.TargetLanguage.ArkTS?"app-harmony":""}function Ye(e,t,r){const i=r.parent;if(i&&e.isCallExpression(i))if(e.isIdentifier(i.expression)){const e=i.expression.getText();if("watch"===e||"watchEffect"===e||"watchPostEffect"===e||"watchSyncEffect"===e)return!1}else if(e.isPropertyAccessExpression(i.expression)){const e=i.expression.name.getText();if("then"===e||"catch"===e)return!1}return!0}const Ze=["/uni-app-x/types/uni/","/uni-app-x/types/uni-cloud/"];function et(e,t){const r=e.getSourceFile();if(r.isDeclarationFile){if(!0===r.__isUTSDeclarationFile)return!0;if(!1===r.__isUTSDeclarationFile)return!1;const e=o(r.fileName);return e.startsWith(t)||Ze.some((t=>e.includes(t)))?(r.__isUTSDeclarationFile=!0,!0):(r.__isUTSDeclarationFile=!1,!1)}return!0}exports.UniXCompiler=class{constructor(e){this._options=e}debug(e,...t){return this._utsCompiler.debug(e,...t)}close(){return this._utsCompiler.close()}wait(e){return this._utsCompiler.wait(e)}getRootFiles(){return this._utsCompiler.getRootFiles()}addRootFile(e,t=1e3){return this._utsCompiler.addRootFile(e,t)}addRootFiles(e,t=1e3){return this._utsCompiler.addRootFiles(e,t)}getDiagnostics(){return this._utsCompiler.getDiagnostics()}async invalidate(e){}init(){if(this._utsCompiler)return Promise.resolve();const e=this._options,{mode:t,targetLanguage:r,hxLanguageServiceDir:a}=e,l=e.tsFactory(We()),c=o(e.inputDir),u=o(e.outputDir),p=a?i.resolve(a,"builtin-dts"):"";let d=e.utsLibDir;const g=o(i.resolve(d,"uts/types/uts")),m=o(i.resolve(d,"uts/types/uni-x")),y=Qe(r);y||(console.error(`${r} is unsupported`),process.exit(0));const h=o(i.resolve(m,y,"paths.json")),T=[i.resolve(m,`${y}.d.ts`)],x=i.resolve(c,"../uni-ext-api.d.ts");n.existsSync(x)&&T.push(x);let _="",N="",v="",F="";"app-harmony"===y&&(F=i.resolve(m,y)),a&&p&&n.existsSync(p)?(_=o(i.resolve(p,"uts-types/common")),N=o(i.resolve(p,`uts-types/${y}`)),v=o(i.resolve(p,"uniappx/node_modules/@dcloudio/uni-app-x/types")),"app-android"!==y&&"app-ios"!==y||(F=o(i.resolve(a,`../uts-development-${y.replace("app-","")}/uts-types/${y}`)))):(_=o(i.resolve(g,"common")),N=o(i.resolve(m,y)),v=o(i.resolve(require.resolve("@dcloudio/uni-app-x/package.json",{paths:[d]}),"../types")));const b={};if(F&&n.existsSync(h)){const e=require(h);Object.keys(e).forEach((t=>{const r=[];e[t].forEach((e=>{r.push(i.resolve(F,e))})),b[t]=r}))}e.rootFiles&&e.rootFiles.length&&T.push(...e.rootFiles);const E=[i.resolve(m,"@vue/runtime-core/dist/runtime-core.d.ts")],D={rootDir:c,baseUrl:c,outDir:u,noImplicitAny:!1,noImplicitThis:!0,useDefineForClassFields:!1,sourceMap:"development"===process.env.NODE_ENV,inlineSources:"development"===process.env.NODE_ENV,noEmitOnError:!1,skipLibCheck:!0,resolveJsonModule:!1,typeRoots:[],paths:{"@uts/common.d.ts":[i.resolve(_,"common.d.ts")],[`@uni-x/${y}.d.ts`]:[i.resolve(N,"index.d.ts")],"@dcloudio/uni-app-x/index.d.ts":[i.resolve(v,"index.d.ts")],"@vue/shared":[i.resolve(m,"@vue/shared/dist/shared.d.ts")],"@vue/reactivity":[i.resolve(m,"@vue/reactivity/dist/reactivity.d.ts")],"@vue/runtime-core":E,vue:E,...b,...e.paths}},A={getCanonicalFileName:e=>e,getCurrentDirectory:()=>c,getNewLine:()=>l.sys.newLine},C={mode:t,typescript:l,inputDir:c,cacheDir:e.cacheDir,rootFiles:T,incremental:e.incremental,compilerOptions:D,reportFileName:function(e){let t="other";(e=o(e)).startsWith(g)?(t="system",e="uts:"+i.relative(g,e)):e.startsWith(m)?(t="system",e="uni-x:"+i.relative(m,e)):e.startsWith(v)?(t="system",e="uni-x:"+i.relative(v,e)):e.startsWith(_)?(t="system",e="uts:"+i.join("common",i.relative(_,e))):e.startsWith(N)?(t="system",e="uni-x:"+i.join(y,i.relative(N,e))):F&&e.startsWith(F)?(t="system",e=y+":"+i.relative(F,e)):e.startsWith(c)&&(t="user",e=i.relative(c,e));return{type:t,fileName:e}},reportDiagnostic:function(t){if(He.enabled){const[r,s]=function(t,r){const s=`${function(e,t=!0){const r=l.DiagnosticCategory[e.category];return t?r.toLowerCase():r}(t)} UTS${t.code}: ${l.flattenDiagnosticMessageText(t.messageText,r.getNewLine())}`;if(t.file){let{line:r,character:o}=l.getLineAndCharacterOfPosition(t.file,t.start);r+=1,o+=1;let a=t.file.fileName.replace("?type=page","");if(e.originalPositionForSync){const t=a+".map";if(n.existsSync(t)){const i=e.originalPositionForSync({sourceMapFile:t,line:r,column:o-1});i&&i.source&&(r=i.line,o=i.column,a=i.source)}}return i.isAbsolute(a)&&(a=i.relative(c,a)),a=a.replace(/\.(uvue|vue|uts)\.ts/,".$1"),[s,`at ${a}:${r}:${o}`]}return[s]}(t,A);console.warn("​"+r+"​"),s&&console.log(s)}},createTransformers:function(t){return S(l,qe(r,e.transformOptions),{targetLanguage:r,setParentRecursive:!1,transformObjectLiteral:{shouldTransformAsExpression(e){const t=(e=l.getOriginalNode(e)).parent;return!(t&&l.isCallExpression(t)&&Je(l,t))}},transformArguments:{shouldTransform(e,t,r){if(function(e,t,r){if(!t.isArrowFunction(e)&&!t.isFunctionExpression(e))return!1;const i=e.parent;if(!t.isCallExpression(i))return!1;const n=i.expression;if(!t.isPropertyAccessExpression(n))return!1;const s=n.name.getText();if(!Be.includes(s))return!1;const o=r.getNonNullableType(r.getTypeAtLocation(n.expression));return!(!r.isArrayType(o)&&!r.isArrayLikeType(o))||(o.isUnion()||o.isIntersection()?o.types.some((e=>ze(e))):!!ze(o))}(e=l.getOriginalNode(e),l,r))return!1;const i=l.isMethodDeclaration(e)?e.parent:e.parent.parent;if(i&&l.isObjectLiteralExpression(i)){let e=i.parent;if(e&&(l.isAsExpression(e)&&(e=e.parent),l.isCallExpression(e)))if(l.isIdentifier(e.expression)){const t=e.expression.getText();if(Xe.includes(t))return!1}else if(Je(l,e))return!1}return Ye(l,r,e)}},transformReturnType:{shouldTransform(e,t,r){if(e=l.getOriginalNode(e),l.isMethodDeclaration(e)&&l.isIdentifier(e.name)){if("provide"===e.name.getText())return!1}return Ye(l,r,e)}},transformGenericsParameterDefaults:{shouldTransform(e,t,r,i){if((l.isCallExpression(e)||l.isNewExpression(e))&&!function(e,t,r){const i=function(e,t){const r=t.getSymbolAtLocation(e);if(r){const e=r.declarations;if(e&&e.length>0)return e[0]}}(e,t);if(i)return et(i,r);return!0}(e.expression,r,o(i.getCompilerOptions().rootDir||"")))return!1;if(t&&(t.aliasSymbol||t.symbol)){const e=(t.aliasSymbol||t.symbol).declarations;if(e&&e.length>0&&!et(e[0],o(i.getCompilerOptions().rootDir||"")))return!1}return!0}},transformRestParameters:{shouldTransform(e,t,r,i){const n=t.declaration;return!n||et(n,o(i.getCompilerOptions().rootDir||""))}}})(t)},watchFile:e.watchFile,normalizeFileName:e.normalizeFileName,sourceMapCallback:(e,t,a)=>{const l=o(i.relative(u,e));if(e.endsWith(".uvue.map")||e.endsWith(".vue.map")){const e=i.resolve(c,l.replace(".map",".ts.map"));if(n.existsSync(e)){t=function(e,t){if(!e)return t;if(!t)return e;const r=JSON.parse(e),i=JSON.parse(t),n=new s.SourceMapConsumer(r),o=new s.SourceMapConsumer(i),a=new s.SourceMapGenerator(r);o.eachMapping((function(e){if(null==e.originalLine)return;const t=n.originalPositionFor({line:e.originalLine,column:e.originalColumn});null!=t.source&&a.addMapping({original:{line:t.line,column:t.column},generated:{line:e.generatedLine,column:e.generatedColumn},source:t.source,name:t.name})}));return[r,i].forEach((function(e,t){e.sources.forEach((function(e){const r=(0===t?n:o).sourceContentFor(e);null!=r&&a.setSourceContent(e,r)}))})),a.toString()}(n.readFileSync(e,"utf8"),t)}}return a?.(e,function(e,t){const r=JSON.parse(t);return r.sources=r.sources.map((t=>{const r=t.split("/.tsc/"+Qe(e)+"/");return(t=(t=r[1]||r[0]).split("?")[0]).replace(".uts.ts",".uts")})),JSON.stringify(r)}(r,t)),!0}};return this._utsCompiler=new f(C),this._utsCompiler.init()}},exports.initTargetHacker=We,exports.initTargetTransformers=qe;
